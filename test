<#
.SYNOPSIS
    Installs or uninstalls software silently with detailed logging.

.DESCRIPTION
    This script performs silent installation of an MSI and an EXE (with the EXE using the "-q" flag)
    while capturing logs for both. For the MSI, it uses msiexecâ€™s logging parameter (/L*V). During uninstallation,
    it uninstalls the MSI using its product code (with logging), runs any uninstall.exe found in a Cytoscape directory,
    and optionally removes a desktop shortcut from the Public Desktop if the -removeShortcut switch is provided.

.PARAMETER install
    Use this switch to perform the installation.

.PARAMETER uninstall
    Use this switch to perform the uninstallation.

.PARAMETER removeShortcut
    When used with -uninstall, this switch removes the desktop shortcut (assumed to be "Cytoscape.lnk")
    from the Public Desktop.

.NOTES
    The installation files are assumed to be in the same folder as this script.
    Update "YourInstaller.msi", "YourInstaller.exe", and the desktop shortcut name as needed.
#>

param(
    [switch]$install,
    [switch]$uninstall,
    [switch]$removeShortcut
)

# Validate that exactly one action is specified
if ($install -and $uninstall) {
    Write-Error "Please specify only one action: -install or -uninstall."
    exit 1
}
if (-not ($install -or $uninstall)) {
    Write-Error "Please specify an action: -install or -uninstall."
    exit 1
}

# Set $PSScript to the directory where the script is located
$PSScript = Split-Path -Parent $MyInvocation.MyCommand.Definition

if ($install) {
    # --------------------------
    # Silent Installation with Logging
    # --------------------------
    
    # MSI silent installation with logging
    $msiPath = Join-Path $PSScript "YourInstaller.msi"  # <-- Replace with your MSI file name
    if (Test-Path $msiPath) {
        $msiLogFile = Join-Path $PSScript "msi_install.log"
        Write-Host "Installing MSI silently from $msiPath..."
        Start-Process -FilePath "msiexec.exe" `
                      -ArgumentList "/i `"$msiPath`" /qn /L*V `"$msiLogFile`"" `
                      -Wait -NoNewWindow
    }
    else {
        Write-Host "MSI file not found at $msiPath"
    }

    # EXE silent installation with logging (using -q switch)
    $exePath = Join-Path $PSScript "YourInstaller.exe"  # <-- Replace with your EXE file name
    if (Test-Path $exePath) {
        $exeLogFile = Join-Path $PSScript "exe_install.log"
        Write-Host "Installing EXE silently from $exePath..."
        Start-Process -FilePath $exePath `
                      -ArgumentList "-q" `
                      -RedirectStandardOutput $exeLogFile `
                      -RedirectStandardError $exeLogFile `
                      -Wait -NoNewWindow
    }
    else {
        Write-Host "EXE installer not found at $exePath"
    }
}

if ($uninstall) {
    # --------------------------
    # Silent Uninstallation with Logging
    # --------------------------
    
    # Uninstall MSI silently using its product code with logging
    $msiUninstallLogFile = Join-Path $PSScript "msi_uninstall.log"
    Write-Host "Uninstalling MSI with product code {B6031041-8C2C-4294-B525-DBC257A825F0}..."
    Start-Process -FilePath "msiexec.exe" `
                  -ArgumentList "/x {B6031041-8C2C-4294-B525-DBC257A825F0} /qn /L*V `"$msiUninstallLogFile`"" `
                  -Wait -NoNewWindow

    # Uninstall via uninstall.exe in the Cytoscape directory (using -q with logging)
    $cytoscapeDirs = Get-ChildItem -Path "C:\Program Files" -Directory | Where-Object { $_.Name -like "Cytoscape_v*" }
    if ($cytoscapeDirs) {
        foreach ($dir in $cytoscapeDirs) {
            $uninstallExe = Join-Path $dir.FullName "uninstall.exe"
            if (Test-Path $uninstallExe) {
                $uninstallLog = Join-Path $PSScript ("uninstall_" + $dir.Name + ".log")
                Write-Host "Running uninstall.exe from $($dir.FullName)..."
                Start-Process -FilePath $uninstallExe `
                              -ArgumentList "-q" `
                              -RedirectStandardOutput $uninstallLog `
                              -RedirectStandardError $uninstallLog `
                              -Wait -NoNewWindow
            }
            else {
                Write-Host "uninstall.exe not found in $($dir.FullName)"
            }
        }
    }
    else {
        Write-Host "No directory matching 'Cytoscape_v*' found in C:\Program Files"
    }
    
    # Optionally remove desktop shortcut from Public Desktop
    if ($removeShortcut) {
        $commonDesktop = [System.Environment]::GetFolderPath("CommonDesktopDirectory")
        $shortcutPath = Join-Path $commonDesktop "Cytoscape.lnk"  # <-- Replace with your actual shortcut name if needed
        if (Test-Path $shortcutPath) {
            Write-Host "Removing desktop shortcut at $shortcutPath..."
            Remove-Item $shortcutPath -Force
        }
        else {
            Write-Host "No desktop shortcut found at $shortcutPath."
        }
    }
}
